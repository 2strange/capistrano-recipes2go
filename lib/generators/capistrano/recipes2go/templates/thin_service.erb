[Unit]
Description=<%= fetch(:thin_daemon_file) %>
After=network.target syslog.target

[Service]
Type=simple

User=<%= fetch(:thin_daemon_user) %>
Group=<%= fetch(:thin_daemon_user) %>

WorkingDirectory=<%= current_path %>

<% if fetch(:thin_daemon_ruby_vm) == :rvm %>
ExecStart=<%= rvm_prefix %> bundle exec thin -C config/thin_app_<%= fetch(:stage) %>.yml start
ExecStop=<%= rvm_prefix %> bundle exec thin -C config/thin_app_<%= fetch(:stage) %>.yml stop
ExecReload=<%= rvm_prefix %> bundle exec thin -C config/thin_app_<%= fetch(:stage) %>.yml restart
<% else %>
ExecStart=/usr/local/bin/bundle exec thin -C config/thin_app_<%= fetch(:stage) %>.yml start
ExecStop=/usr/local/bin/bundle exec thin -C config/thin_app_<%= fetch(:stage) %>.yml stop
ExecReload=/usr/local/bin/bundle exec thin -C config/thin_app_<%= fetch(:stage) %>.yml restart
<% end %>

# Ensure systemd correctly tracks the Thin process
PIDFile=<%= fetch(:thin_pid_path) %>/thin_<%= fetch(:application) %>_<%= fetch(:stage) %>_sysd.pid

# Build PID file after startup
ExecStartPost=/bin/bash -c 'echo $MAINPID > <%= fetch(:thin_pid_path) %>/thin_<%= fetch(:application) %>_<%= fetch(:stage) %>_sysd.pid'
ExecStopPost=/bin/bash -c 'rm -f <%= fetch(:thin_pid_path) %>/thin_<%= fetch(:application) %>_<%= fetch(:stage) %>_sysd.pid'

TimeoutStartSec=<%= fetch(:thin_wait) %>
TimeoutStopSec=<%= fetch(:thin_wait) %>

# Restart policy
Restart=always
RestartSec=5
RemainAfterExit=yes

# Logging
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=thin_<%= fetch(:application) %>_<%= fetch(:stage) %>

[Install]
WantedBy=multi-user.target
